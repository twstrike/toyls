package toyls

import (
	"testing"

	. "gopkg.in/check.v1"
)

func Test(t *testing.T) { TestingT(t) }

type ToySuite struct{}

var _ = Suite(&ToySuite{})

func (s *ToySuite) TestDeserializeClientHello(c *C) {
	helloBody := []byte{
		//client_version
		0x03, 0x03, //ProtocolVersion

		//random (Random)
		0x00, 0x00, 0x00, 0x00, //gmt_unix_time
		0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, //random_bytes
		0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
		0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
		0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,

		//session_id (SessionID)
		0x0A,                                                       //length
		0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, //SessionID

		//cipher_suites
		0x00, 0x02, // length
		0x00, 0x2f, // CipherSuite: TLS_RSA_WITH_AES_128_CBC_SHA

		//compression_methods
		0x01, //length
		0x00, //NULL
	}

	msg, err := deserializeClientHello(helloBody)

	expected := &clientHelloBody{
		clientVersion: protocolVersion{0x03, 0x03},
		random: random{
			0,
			[28]byte{0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
				0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
				0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
				0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07},
		},
		sessionID:          []byte{0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09},
		cipherSuites:       []cipherSuite{cipherSuite{0x00, 0x2f}},
		compressionMethods: []byte{0x00},
	}
	c.Assert(err, IsNil)
	c.Assert(msg, DeepEquals, expected)
}

func (s *ToySuite) TestDeserializeFailsWhenClientHelloCiphersOutOfRange(c *C) {
	helloBody := []byte{
		//client_version
		0x03, 0x03, //ProtocolVersion

		//random (Random)
		0x00, 0x00, 0x00, 0x00, //gmt_unix_time
		0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, //random_bytes
		0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
		0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
		0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,

		//session_id (SessionID)
		0x0A,                                                       //length
		0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, //SessionID

		//cipher_suites
		0xff, 0xff, // length
		0x00, 0x2f, // CipherSuite: TLS_RSA_WITH_AES_128_CBC_SHA

		//compression_methods
		0x01, //length
		0x00, //NULL
	}

	msg, err := deserializeClientHello(helloBody)

	expected := &clientHelloBody{}
	c.Assert(err, NotNil)
	c.Assert(msg, DeepEquals, expected)
}

func (s *ToySuite) TestSerializeClientHello(c *C) {
	helloBytes := &clientHelloBody{
		clientVersion: protocolVersion{0x03, 0x03},
		random: random{
			1,
			[28]byte{0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
				0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
				0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
				0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07},
		},
		sessionID:          []byte{0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09},
		cipherSuites:       []cipherSuite{cipherSuite{0x00, 0x2f}},
		compressionMethods: []byte{0x00},
	}

	msg, err := serializeClientHello(helloBytes)

	expected := []byte{
		//client_version
		0x03, 0x03, //ProtocolVersion

		//random (Random)
		0x00, 0x00, 0x00, 0x01, //gmt_unix_time
		0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, //random_bytes
		0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
		0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
		0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,

		//session_id (SessionID)
		0x0A,                                                       //length
		0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, //SessionID

		//cipher_suites
		0x00, 0x02, // length
		0x00, 0x2f, // CipherSuite: TLS_RSA_WITH_AES_128_CBC_SHA

		//compression_methods
		0x01, //length
		0x00, //NULL
	}

	c.Assert(err, IsNil)
	c.Assert(msg, DeepEquals, expected)
}
